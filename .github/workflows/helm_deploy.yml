name: Helm Deploy to ArgoCD

on:
  workflow_call:
    inputs:
      app_name:
        type: string
        required: true            # Name of the application (for commit message)

      values_path:
        type: string
        required: true            # Path to Helm values file (inside infra repo)

      image_name:
        type: string
        required: true            # Docker image name (without registry)

      image_tag:
        type: string
        required: true            # Tag returned from CI

      helm_repo:
        type: string
        required: false
        default: "eranin/eranin-infra"   # Infra repo that stores all deployments

    secrets:
      INFRA_REPO_TOKEN:
        required: true           # Token with write access to infra repo

      IMAGE_REGISTRY:
        required: true           # Registry host (e.g., 103.162.20.16:5000)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # ------------------------------------------------------------
      # 1) Checkout infrastructure repository (ArgoCD GitOps repo)
      # ------------------------------------------------------------
      - name: Checkout Infra Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.helm_repo }}
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          fetch-depth: 0

      # ------------------------------------------------------------
      # 2) Install YQ (safe + deterministic install method)
      # ------------------------------------------------------------
      - name: Install yq
        run: |
          sudo curl -L \
            "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64" \
            -o /usr/bin/yq

          sudo chmod +x /usr/bin/yq
          echo "yq installed version:"
          /usr/bin/yq --version

      # ------------------------------------------------------------
      # 3) Patch Helm values.yaml with new image repository + tag
      # ------------------------------------------------------------
      - name: Update Helm Values
        run: |
          FILE="${{ inputs.values_path }}"
          REG="${{ secrets.IMAGE_REGISTRY }}"
          NAME="${{ inputs.image_name }}"
          TAG="${{ inputs.image_tag }}"

          echo "Updating Helm values file: $FILE"
          echo " -> repository: $REG/$NAME"
          echo " -> tag:        $TAG"

          # Inject image repo + tag into Helm chart values
          /usr/bin/yq -i ".deployment.image.repository = \"${REG}/${NAME}\"" "$FILE"
          /usr/bin/yq -i ".deployment.image.tag = \"${TAG}\"" "$FILE"

          echo "---- Updated file content ----"
          cat "$FILE"
          echo "------------------------------"

      # ------------------------------------------------------------
      # 4) Commit & push changes (only if file was modified)
      # ------------------------------------------------------------
      - name: Commit & Push
        run: |
          git config user.email "cd-bot@eranin.dev"
          git config user.name "Eranin-CD-Bot"
          
          git add .

          # No commit if file has no changes
          if git diff --cached --quiet; then
            echo "No changes to commit. Deployment skipped."
            exit 0
          fi

          git commit -m "CD: Update ${{ inputs.app_name }} â†’ tag ${{ inputs.image_tag }}"
          git push

      # ------------------------------------------------------------
      # 5) Summary for GitHub Actions UI
      # ------------------------------------------------------------
      - name: Summary
        run: |
          echo "CD updated image:" >> $GITHUB_STEP_SUMMARY
          echo "**${{ secrets.IMAGE_REGISTRY }}/${{ inputs.image_name }}:${{ inputs.image_tag }}**" >> $GITHUB_STEP_SUMMARY

