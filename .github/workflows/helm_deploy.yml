name: Helm Deploy to ArgoCD

on:
  workflow_call:
    inputs:
      app_name:
        type: string
        required: true

      values_path:
        type: string
        required: true

      image_name:
        type: string
        required: true

      image_tag:
        type: string
        required: true

      image_path:
        type: string
        required: true

      helm_repo:
        type: string
        required: false
        default: "eranin/eranin-infra"

    secrets:
      INFRA_REPO_TOKEN:
        required: true
      IMAGE_REGISTRY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ======================================================
      # CHECKOUT INFRA REPO
      # ======================================================
      - name: Checkout Helm Infra Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.helm_repo }}
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          fetch-depth: 0

      # ======================================================
      # INSTALL YQ (CHUẨN 100%)
      # ======================================================
      - name: Install yq
        run: |
          sudo curl -L \
            "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64" \
            -o /usr/bin/yq
      
          sudo chmod +x /usr/bin/yq
          ls -l /usr/bin/yq
          yq --version

      # ======================================================
      # DEBUG INPUTS
      # ======================================================
      - name: Debug Inputs
        run: |
          echo "Registry: ${{ secrets.IMAGE_REGISTRY }}"
          echo "Image name: ${{ inputs.image_name }}"
          echo "Tag: ${{ inputs.image_tag }}"
          echo "Values file: ${{ inputs.values_path }}"
          echo "Key path: ${{ inputs.image_path }}"

      # ======================================================
      # UPDATE HELM VALUES
      # ======================================================
      - name: Update Helm values
        run: |
          FILE="${{ inputs.values_path }}"
          PATH="${{ inputs.image_path }}"

          echo "Updating: $FILE"
          echo " → repository: ${{ secrets.IMAGE_REGISTRY }}/${{ inputs.image_name }}"
          echo " → tag: ${{ inputs.image_tag }}"

          yq -i ".$PATH.repository = \"${{ secrets.IMAGE_REGISTRY }}/${{ inputs.image_name }}\"" "$FILE"
          yq -i ".$PATH.tag = \"${{ inputs.image_tag }}\"" "$FILE"

          echo "Updated file:"
          cat "$FILE"

      # ======================================================
      # COMMIT & PUSH
      # ======================================================
      - name: Commit & Push
        run: |
          git config user.email "cd-bot@eranin.dev"
          git config user.name "Eranin-CD-Bot"

          git add .

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "CD: Update ${{ inputs.app_name }} to tag ${{ inputs.image_tag }}"
          git push

      - name: Summary
        run: |
          echo "CD Updated successfully."
          echo "Image: ${{ secrets.IMAGE_REGISTRY }}/${{ inputs.image_name }}:${{ inputs.image_tag }}"
